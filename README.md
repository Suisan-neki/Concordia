# 🩺 Concordia 仕様書 ver.0.1  
### ― 圧力のない説明と理解のための院内情報共有基盤 ―  
---

## 0. 概要（Abstract）

**Concordia** は、医療現場における「説明と理解」のプロセスを、  
圧力なく、誤解なく、透明に記録するための院内情報共有基盤である。  

本システムは従来の「患者合意システム（PHR-Nexus 内部モジュール）」の延長として構築され、  
単に“合意を取得する”のではなく、**合意という行為そのものの意味を問い直し、  
それを支えるための心理的・技術的構造を再設計する**ことを目的とする。  

キーワードは  
> 「Zero Pressure Architecture」  
> 「内在的脅威への設計」  
> 「Transparency with Dignity」  

である。  

---

## 1. 導入（Introduction）

当初、本開発プロジェクト（院内PHR）は「患者と医師が診療情報を共有し、  
双方が同じ情報を見ながら合意を得る」ことを目的にしていた。  

だが開発を進める中で、次の問いにぶつかった。  

> 「合意を取ることが、本当に両者の安心につながっているのか？」  
> 「“合意しました”という記録は、むしろ圧力になっていないか？」  

医師は「訴訟や誤解を避けたい」という恐れを抱き、  
患者は「その場で本音を言いづらい」という不安を抱える。  
ここにあるのは“情報非対称”ではなく、**心理的圧力の非対称**である。  

そして気づいた。  
「完全な合意」は存在しない。  
人間の理解は揺らぎ、言葉にできない不安は残る。  
だがそれでも、**「理解しようとした軌跡」だけは技術的に残すことができる。**

その考えから、**Concordia** が生まれた。  

---

## 2. 背景思想（Philosophical Context）

### 2.1 「合意」から「理解」へ  
従来の医療合意システムは、医療法的文脈における「合意の有無」を記録するものであった。  
しかし、現実の診療現場では、合意とは  
- 情報の理解  
- 判断の過程  
- 感情の変化  
が混在する複雑な行為であり、「はい／いいえ」で切り分けることはできない。  

Concordia は、合意という**行為の最小単位**を「理解行動（understanding act）」と再定義する。  
つまり、“合意（agreement）”ではなく、“理解の痕跡（trace of understanding）”を扱う。  

### 2.2 内在的脅威（Inherent Threats）
本システムが相手にする「脅威」は外部攻撃者ではない。  
脅威は内部に宿る。  

- 医師の「疑われることへの恐れ」  
- 患者の「発言をためらう不安」  
- 管理者の「監視システム化への抵抗」  

これらの**心理的防衛反応**こそが、  
医療現場の透明性を阻む“見えないセキュリティリスク”である。  

Concordia の設計は、これら**内在的脅威を中和する構造**を持つ。  

### 2.3 目的  
「誰も責めず、誰も責められない環境を技術でつくる」  
これが Concordia の基本理念である。  
セキュリティは防御のためではなく、**安心のための設計原理**と位置づける。

---

## 3. システム概要（System Overview）

### 3.1 概念構造（Conceptual Structure）

| レイヤ / 要素 | 説明 |
|----------------|------|
| **患者 ── 対話 ── 医師** | 診療室内の説明・理解・合意プロセスを双方向に接続する。 |
| **理解行動ログ** | 双方の操作・質問・閲覧行動を時系列に記録する中核データ。 |
| **Concordia Layer** | 以下4要素から構成される、理解・安心・透明性を支える基盤層。 |
| ├─ Zero Pressure Architecture (ZPA) | 圧力ゼロ設計。行動が強制ではなく選択であることを保証するUI／設計思想。 |
| ├─ Comprehension Ledger（理解台帳） | 理解行動を暗号署名付きトランザクションとして保存。 |
| ├─ Merkle Integrity Chain | 全履歴の改ざん検知を担うハッシュチェーン構造。 |
| └─ Selective Visibility（ABAC） | 役割・目的ごとに開示範囲を制御する属性ベースアクセス制御。 |

### 3.2 基本原理

| 原理 | 内容 | 技術的実装イメージ |
|--------|------|----------------|
| **Zero Pressure Architecture** | 「圧力ゼロ」の設計思想。<br>説明・署名・確認の各行為を“強制”でなく“選択”として提示。 | ステップ合意UI＋再質問機構 |
| **Comprehension Ledger** | 合意ではなく「理解行動」を暗号署名付きで記録。 | 患者・医師の確認操作／質問／再閲覧をトランザクション化 |
| **Merkle Integrity Chain** | 全記録をチェーン化し改ざんを検知。 | WORM構造＋ハッシュチェーン |
| **Selective Visibility (ABAC)** | 「見せすぎない透明性」。<br>診療・教育・監査で開示範囲を切り替える。 | 属性ベースアクセス制御＋データマスキング |

---

## 4. コア設計方針（Core Design Principles）

| 方針 | 説明 | キーワード |
|--------|--------|--------------|
| **P1. 理解の痕跡を残す** | 合意そのものではなく、理解しようとしたプロセスを記録する。 | Trace of Understanding |
| **P2. 圧力ゼロ設計** | 「押すこと」を負担にしない。1タップ署名＋再考可能UI。 | Zero Pressure |
| **P3. 不可視の信頼を強制しない** | 「信頼せよ」と命じない。技術的透明性で心理的安全を補う。 | Transparency with Dignity |
| **P4. 内在的脅威への対応** | 人間の恐れ・防衛反応をセキュリティ設計の中心に置く。 | Inherent Threat Model |
| **P5. 再学習可能性** | 記録は“証拠”ではなく“改善素材”。医療説明の質向上へ。 | Learning Feedback Loop |

---

## 5. 開発・テストガイドライン

### 5.1 テストデータ生成のベストプラクティス

**⚠️ 重要なセキュリティガイドライン**

テストデータの生成には以下のルールを厳守してください：

- ❌ **禁止**: 本番データをコピーしてテストに使用
- ❌ **禁止**: 実在データをテストに混ぜる
- ✅ **推奨**: [Fakerライブラリ](https://faker.readthedocs.io/)を使用してダミーデータを生成

**理由:**
- セキュリティリスクの回避（本番データの漏洩防止）
- プライバシー保護（実在ユーザーの個人情報保護）
- データの整合性（テスト環境と本番環境の分離）
- 再現性（テストデータの一貫性と予測可能性）

**実装例:**
```python
from faker import Faker

fake = Faker('ja_JP')  # 日本語データ生成

# 患者データの生成例
patient_data = {
    'name': fake.name(),
    'email': fake.email(),
    'phone': fake.phone_number(),
    'birth_date': fake.date_of_birth(minimum_age=18, maximum_age=100)
}
```

---

## 6. 今後の仕様セクション（予定）

| 章 | 内容 |
|------|------|
| **6. 機能仕様** | 主要機能（合意プロセス管理、理解ログ、署名・可視化UI） |
| **7. セキュリティ設計** | 暗号構造、署名方式、改ざん検知、ABACモデル |
| **8. UX設計** | ステップ型合意UI、Zero Pressure Interaction設計 |
| **9. ユースケース** | 医師・患者・監査者それぞれの利用シナリオ |
| **10. 今後の展開** | 医療AI学習・教育・地域連携への応用可能性 |

---

## 6. 機能仕様（Functional Specification）

| 項目 | 説明 | 実装メモ |
|------|------|----------|
| セッション管理 | 医師が説明セッションを開始し、資料ハッシュを固定。 | `/sessions` API、Artifact SHA-256 を Ledger に記録。 |
| 理解行動ログ | `view/clarify_request/re_explain/agree/revisit` などのイベントを鎖に刻む。 | `understanding_events` + Merkle Chain。 |
| 合意署名 | Ed25519 + PIN/TOTP。`agree/reagree/revoke` で署名必須、TSA トークンを保存。 | `/auth/keys` で公開鍵登録、`signature_records` に記録。 |
| Telemetry | Clarify・再閲覧率などから Calm/Observe/Focus のゾーンを算出し、`/metrics` と HTML で可視化。 | `metrics_snapshots`、Celery でバッチ集計予定。 |
| Access Logging | 全 API に ABAC チェックを挟み、`access_logs` に許可/拒否を記録。 | `AccessEvaluator` サービスで共通実装。 |

---

## 7. セキュリティ設計（Security Architecture）

1. **不可否認性**  
   - Ed25519 署名 + 公開鍵登録 (`/auth/keys`)。  
   - 署名イベントに対して TSA スタブ（将来は RFC3161）で時刻証明。  
   - 署名検証に失敗したイベントは 400 番台で拒否。

2. **改ざん検知**  
   - 理解行動ごとに `prev_hash`／`curr_hash` を連結し Merkle Chain を構築。  
   - `verify-metrics` など CLI で再計算可能な canonical JSON を採用。  
   - チェーンルートは日次で immutability Store（今後は immudb）へスナップショット。
   - `python scripts/verify_chain.py --session-id sess-1` で任意セッションの鎖を検証可能。

3. **ABAC / Selective Visibility**  
   - `PolicyContext(subject_id, role, purpose)` で評価。  
   - 患者は自身セッションのみ閲覧可、監査者はメタデータのみ。  
   - すべてのアクセスは `access_logs` に残し、既定で HTML/JSON から監視可能。

4. **テストデータ生成規約**  
   - Faker によるダミーデータのみ使用、本番データのコピーは禁止（節 5.1 参照）。

---

## 8. UX設計（Zero Pressure Interaction）

| フェーズ | 患者ビュー | 医師ビュー | Zero Pressure 施策 |
|----------|-----------|------------|--------------------|
| 説明開始 | 資料要約＋ SHA-256 表示 | シナリオガイド＋質問ログ | Hash 表示で「説明が固定された」安心感。 |
| 再確認 | 常設 Clarify ボタン＋「あとで聞く」リンク | 再説明テンプレート＋スレッドビュー | 質問の匿名化・1タップ送信・後追いチャネル。 |
| 合意/保留 | PIN+署名 or 保留ボタン、Comfort Zone メッセージ | 署名ステータス / 保留理由 | いつでも保留可、押さなかった記録も Ledger へ。 |
| 再閲覧 | 24h チャネル＋履歴ダッシュボード | 再閲覧通知 | セッション後も質問できると明示し、ドキドキを下げる。 |
| 指標確認 | Calm/Observe/Focus のゾーン表示（opt-in） | 集計のみ共有、個別は自己レビュー | 見ない権利、緩衝メッセージを徹底。 |

---

## 9. ユースケース（Use Cases）

1. **医師**  
   1. セッション開始: `/sessions` で説明セッションを生成し、資料の SHA-256 を患者と共有。  
   2. 説明中: 資料ステップごとに Clarify を促し、再説明イベントを Ledger へ。  
   3. 合意フェーズ: Ed25519 署名をリクエストし、`/events` 経由で Merkle + Telemetry に反映。  
   4. 終了後: 24h チャネルを見守り、追加 Clarify にテンプレで回答。  
   5. 監査対応: `/audit/logs` と `/audit/signatures` で操作履歴と署名/TSA を提示。

2. **患者**  
   1. タイムライン画面（`/view/.../timeline/html`）で説明の進行と Comfort Zone を確認。  
   2. わからない箇所は Clarify ボタン／「あとで聞く」で記録し、医師へ通知。  
   3. 合意時は PIN + 署名、保留した場合もイベントとして残り「押さない自由」を証明。  
   4. 診察後、再閲覧フォームでいつでもログを見返し、必要なら再合意/撤回を実行。  
   5. 自分のログを `/audit/logs?actor_id=xxx` で参照し、第三者アクセスも把握。

3. **監査者**  
   - `/audit/logs` でアクセス経路を確認し、必要に応じて `/audit/signatures` で TSA トークンを検証。  
   - ABAC によりメタデータのみ閲覧（質問文はマスク）し、最小開示を維持。

---

## 10. 今後の展開（Next Steps）

| 項目 | 内容 |
|------|------|
| **Telemetry 拡張** | Kafka/Streams でリアルタイム指標、施設単位の比較。 |
| **署名強化** | 外部 TSP / HSM 連携、ハードウェアキーや生体認証への対応。 |
| **フロントエンド** | Next.js + Tailwind による患者/医師用の本格 UI、ダッシュボード。 |
| **医療外展開** | 営業・不動産・カスタマーサポートなど、対話の誤解がクレーム/炎上につながる領域で Zero Pressure ログを活用。カスハラ抑止、従業員支援、説明責任の透明化に応用。 |
| **地域連携** | 院内のみならず、地域医療ネットワークへの展開を想定（VPN/ゼロトラスト）。 |

これらの章を順次肉付けし、Concordia の Zero Pressure Architecture を「仕様 → 実装 → UX → 運用」まで一貫したドキュメントとして仕上げる。

---

## 11. Zero Pressure を実現する理由（Why It Works）

1. **選択肢の存在を証明**  
   - Clarify／保留／後日再閲覧といった「押さなくてもよい」行為がすべてイベントとして鎖に刻まれ、押さなかった履歴すら価値になる。  
   - 「押さない自由」が保障されているため、押す瞬間の圧力が下がる。

2. **不可否認性 = 安心の裏付け**  
   - Ed25519 署名と TSA トークンで「私が選んだ」という証跡が残るので、「押してないのに押された」という恐れを抱かずに済む。  
   - 医師側も説明ログが自動で記録され、防衛的な説明から解放される。

3. **監査＝味方であることを可視化**  
   - アクセスログや署名記録は患者本人が閲覧でき、第三者による過剰監視が起きていないか自分でチェックできる。  
   - 監査者はメタデータのみ閲覧するため、必要以上に晒されることがない。

4. **安心指標の再定義**  
   - Clarify や保留を「悪い数字」にしない。Calm/Observe/Focus のゾーン表示で「問い直しが多い＝安心の証拠」と捉える。  
   - 指標を見ない権利（opt-in）や緩衝メッセージを徹底し、数字で脅さない。

これらの仕組みにより、Concordia は「合意を急かす/押し付ける構造」から離れ、理解しようとした軌跡そのものに価値を置ける。これこそが Zero Pressure Architecture と呼べる理由である。
