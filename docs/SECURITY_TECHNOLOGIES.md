# 尖った技術カタログ（意図と便益を丁寧に）

この文書は「なぜその技術が必要か」「誰にどう嬉しいか」「何を最初に作るか」を、院内ステークホルダーにも伝わる言葉でまとめ直したものです。UIやABACは最小限にし、暗号・鎖・時刻・秘匿集計といった“裏側の信頼”を主役に据えます。

- ゴール: 説明→再確認→再説明→合意/保留→再閲覧の一連の行動を、改ざん不能かつ“圧力ゼロ”で可視化する。
- 優先: ①鎖の完全性 ②署名/時刻の裏付け ③秘匿集計によるテレメトリ。
- 省略: リッチなUIや重厚なABACは後回し。閲覧は最小限、権限は軽量トークンで代替。

---

## 1) Ledger + Merkle を強化する（BLAKE3／MMR／外部アンカー）

目的
- “記録が動かない”ことを技術で示し、疑いと不安を下げる。

何をする
- ハッシュ方式を二重化: 既存の SHA‑256 に加え BLAKE3 を併記（将来互換を確保）。
- 形を最適化: 追記に強い Merkle Mountain Range(MMR)で日次ルートを作る。
- 外部アンカー: 日次ルートを OpenTimestamps 等に時刻アンカー（オフライン時はキュー）。

どう嬉しいか
- 医師: 「あとでログを改ざんしたのでは？」という疑いを受けにくくなる（脅威1）。
- 患者: 自分の選択が後から書き換えられない安心（脅威2・3）。

実装イメージ
- カノニカルJSON（キー順固定/UTC/小数秒）。signature と curr_hash はハッシュ対象外。
- CLI を用意: `verify-session`（再計算検証）、`anchor-day`（日次ルート作成とアンカー）。

注意点
- 仕様（ハッシュ順序・対象）を文書に固定。将来変更は並行運用で移行。

---

## 2) 署名と時刻の裏付け（Roughtime／二重署名／FROSTは将来）

目的
- 「誰が・いつ・どの操作を選んだか」を機械的に裏付け、強制の疑念を減らす。

何をする
- 時刻証明を軽量化: Roughtime や OpenTimestamps を採用（RFC3161に縛られない）。
- 体験を先に再現: 医師端末署名 + サーバ署名を併記し、2‑of‑2 的な性質をデモ。
- 将来の拡張: 本格的な閾値署名（FROST）は後段で検討（まずはスタブ設計）。

どう嬉しいか
- 医師: 「サーバが勝手に押したのでは？」という疑念を避けやすい（脅威1・4）。
- 患者: 「自分がこの時に選んだ」事実が時刻と共に残る（脅威2）。

実装イメージ
- 署名対象ダイジェスト: イベント本体 + `prev_hash`（順序を仕様化）。
- 失敗は明示的に拒否。鍵はPoCではファイル/DB、後でHSMへ移行可能に。

---

## 3) Telemetry を“責めない数字”に（2サーバ秘匿集計／DP／ZPI）

目的
- 指標がプレッシャーにならないよう、個票を見せず“集計だけ”を安全に扱う。

何をする
- 2サーバの加法秘密分散でカウントを合成し、合計だけ復元（個人は不可視）。
- 差分プライバシ（DP）で微小ノイズを加え、再識別を防止（設定でON/OFF）。
- Zero Pressure Index(ZPI) をルールベースで算出（LLMなしで成立）。

どう嬉しいか
- 医師: 「数字で責められている感」を避けられる（脅威4）。
- 患者: 質問行動が個人に紐づかず安心（脅威2・3）。

実装イメージ
- 特徴量: clarify / re_explain / re_view / 合意までの時間間隔 / シグナル多様性 / 主導度。
- 重み・閾値は設定ファイルで調整可能（`.env`/`pyproject.toml`）。

---

## 4) 権限は“軽く確実に”（Macaroons）。ABACは当面スキップ

目的
- 「見せすぎない透明性」を軽量に実現し、運用コストを上げない。

何をする
- Macaroons のケイブアット（条件）で `purpose=care`, `ttl`, `scope=session` を付与。
- ロールは doctor/patient の2つに限定。監査・教育は将来オプション。

どう嬉しいか
- 医師: 必要な相手だけに閲覧を渡せる（脅威3）。
- 患者: 最小開示で安心、期限も明確。

実装イメージ
- 失効/スコープ検証を共通ユーティリティに集約。ZCAP‑LD 等は研究枠に。

---

## 5) 検証が主役の最小UI（とCLI）

目的
- “裏側の信頼”をそのまま見せる。UIは少なく、検証を前面に。

何をする
- 画面は患者タイムラインと医師集計のみ。チェーン検証やアンカー状態をピル表示。
- CLI（`dialog_cli`/`doctor_summary`）でいつでも同じ情報を確認可能。

どう嬉しいか
- 医師: 複雑UIに時間を取られず、肝心の信頼状態だけを即確認。
- 患者: 比較やランキングがなく、数字に追われない（脅威4）。

実装イメージ
- UIは増やさない方針。検証と状態表示に絞る。

---

## 技術→便益→内在的脅威の対応

- 二重ハッシュ+MMR+アンカー → 「記録は動かない」 → 疑われる恐れ/切り取り拡散（脅威1,3）
- Roughtime+二重署名 → 「押させられていない」 → 強制/時刻疑義（脅威1,2,4）
- 2サーバ集計+DP → 「誰も責められない」 → 数値が圧力になる（脅威4）
- Macaroons → 「見せすぎない透明性」 → 過剰監視（脅威3）
- 最小UI/CLI → 「比較を煽らない」 → 可視化が圧力化（脅威4）

---

## 実装順（現実的なロードマップ）

1. Ledger拡張: BLAKE3併記・MMR日次ルート・`anchor-day`/`verify-session` CLI
2. 署名/時刻: Roughtimeスタブ・2署名併記（FROSTは後段）
3. Telemetry: ZPI実装・2サーバ加法分散・DPノイズ（フラグ）
4. 権限: Macaroons閲覧トークン（2ロール固定）
5. 最小UI: 検証ピル/状態表示、CLI整備

各ステップは「医師/患者にとって何が安心になるか」を説明文とともにデモ可能にする。

---

## 電子カルテ（EHR）と Concordia の役割分担、そして“改訂”の考え方

結論から言うと、Concordia は電子カルテの置き換えではありません。目的は「説明・理解・合意に関する行動の透明化」であり、診療記録（所見・処方・検査結果）そのものは既存のEHRの責務です。

1) 役割分担
- EHR（電子カルテ）: 医療行為の事実（所見、診断、処方、指示）、法的記録。編集は院内規程に従う。
- Concordia: 対話の軌跡（present/clarify/re_explain/agree/review など）と、その完全性検証（チェーン/署名/時刻）。

2) 改訂は“追記”で扱う（書き換え≠悪ではないが、痕跡は残す）
- 追加・補足は `ANNOTATE`（追記）として、対象イベントIDと差分を記録。
- 誤りの訂正は `AMEND`、重大な意義がある場合は双方署名を推奨。
- 効力を否認する場合は `RETRACT`（履歴は残す）。
- 個人情報を将来不可読にしたいケースは `FORGET`（暗号封筒＋鍵破棄＝クリプトシュレッディングの方針）。
- いずれも「元を消す」のでなく「後から来たイベント」で上書きの意味合いを表現し、チェーンに連結する。

3) 現場の“その場完結”運用
- 多くのセッションは当日で完結する想定。再閲覧は既定OFF、要望時に有効化。
- 合意後は要点サマリ（要約とハッシュ）のみ発行。詳細ログは院内に保管。
- Telemetry は当日の行動中心（clarify率、説明→合意までの時間、シグナル多様性）で評価し、数値ではなく穏やかなメッセージで返す。

4) これがなぜ“内在的脅威”を和らげるか
- 医師: 「間違えたら終わり」ではなく、後から追記/訂正できる前提で臨める（脅威1・4）。
- 患者: その場で完結しても、必要時に再確認や追記ができる“選択肢”が担保される（脅威2）。
- 監査: 改訂も追記として鎖に残るため、透明性は維持される（脅威3）。

注: 上記の `ANNOTATE/AMEND/RETRACT/FORGET` は将来の ActType 拡張候補です。導入時は署名要否と表示の合成ルール（実効ビュー）を合わせて仕様化します。
